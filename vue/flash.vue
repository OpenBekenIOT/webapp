<template>
    <div>
        <div>
            <span>
                Here you can read device flash directly. RF config is Beken internal configuration memory and Config is our configuration structure.<br>
                Here you can also recover your device from "MAC ends with 00 00 00 and is unable to change" bug. Button 'Restore RF config' will restore RF partition for T and N and set a random MAC address, but this also requires rebooting device later.<br>
            </span>
            <br/>
            <div class="evenly-buttons">
                <button class="button space-distr" @click="rf(null, $event)">Read RF Config</button>
                <button class="button space-distr" @click="config(null, $event)">Read Config</button>
                <button class="button space-distr" @click="flashvars(null, $event)">Read FlashVars</button>            
                <button class="button space-distr" @click="restore_rf(null, $event)">Restore RF Config (N & T)</button>
            </div>
            <br/>
            <br />
            <a :href="rfurl" download="rfdata">Download RF block</a>
            <br/>
            <a :href="configurl" download="configdata">Download Config block</a>
            <br/>
            <a :href="flashvarsurl" download="flashvarsdata">Download Flash Vars block</a>
        </div>
        <div v-html="display" class="display"></div>
    </div>
</template>

<script>
  module.exports = {

    data: ()=>{
      return {
        msg: 'world!',
        rfdata: null,
        display: '',
        configdata: null,
        build:'unknown',
        chipset:'unknown',
        status:'nothing going on',
        rfurl: '',
        configurl: '',
        flashvarsurl: '',
      }
    },
    methods:{
        getinfo(){
            let url = window.device+'/api/info';
            fetch(url)
                .then(response => response.json())
                .then(res => {
                    this.build = res.build;
                    this.chipset = res.chipset;     //Set chipset to fixed value for testing
                    this.rfurl = window.device+'/api/flash/'+this.getRFAddress();
                    this.configurl = window.device+'/api/flash/'+this.getConfigAddress();
                    this.flashvarsurl = window.device+'/api/flash/'+this.getFlashVarsAddress();
                })
                .catch(err => {
                    this.error = err.toString();
                    console.error(err)
                }); // Never forget the final catch!
        },
        getRFAddress(){
            if(this.chipset === "BK7231T") {
				return '1e0000-1000';
			}
            if(this.chipset === "BK7231N") {
				return '1d0000-1000';
			}
            console.log('getRFAddress is not implemented for '+this.chipset);
			return '1e0000-1000';
        },
        getConfigAddress(){
            if(this.chipset === "BK7231T") {
				return '1e1000-1000';
			}
            if(this.chipset === "BK7231N") {
				return '1d1000-1000';
			}
            console.log('getConfigAddress is not implemented for '+this.chipset);
			return '1e1000-1000';
        },
        getFlashVarsAddress(){
            // "NET info" + len(0x1000) + 0x1000
            if(this.chipset === "BK7231T") {
				return '1e3000-2000';
			}
            if(this.chipset === "BK7231N") {
				return '0x1D3000-2000';
			}
            console.log('getConfigAddress is not implemented for '+this.chipset);
			return '1e1000-1000';
        },
        rf(cb){
            this.status += '<br/>reading rf config...';
            let url = window.device+'/api/flash/'+this.getRFAddress();
            console.log('Will use URL '+url);
            fetch(url)
                .then(response => response.arrayBuffer())
                .then(buffer => {
                    this.rfdata = buffer; 
                    console.log('received '+buffer.byteLength);
                    this.status += '..got rf config...';
                    this.dump(buffer);
                    if(cb) cb();
                })
                .catch(err => console.error(err)); // Never forget the final catch!
        },
        config(cb){
            this.status += '<br/>reading config...';
            let url = window.device+'/api/flash/'+this.getConfigAddress();
            console.log('Will use URL '+url);
            fetch(url)
                .then(response => response.arrayBuffer())
                .then(buffer => {
                    this.configdata = buffer; 
                    console.log('received '+buffer.byteLength);
                    this.status += '..got rf config...';
                    this.dump(buffer);
                    if(cb) cb();
                })
                .catch(err => console.error(err)); // Never forget the final catch!
        },
        flashvars(cb){
            this.status += '<br/>reading flashvars...';
            let url = window.device+'/api/flash/'+this.getFlashVarsAddress();
            console.log('Will use URL '+url);
            fetch(url)
                .then(response => response.arrayBuffer())
                .then(buffer => {
                    this.configdata = buffer; 
                    console.log('received '+buffer.byteLength);
                    this.status += '..got rf config...';
                    this.dump(buffer);
                    if(cb) cb();
                })
                .catch(err => console.error(err)); // Never forget the final catch!
        },
        restore_rf(cb){
			  let rep = prompt("Are you certain? This might brick device. Enter yes.", "no");
			  if (rep != null) {
				  if(rep == "yes") {
					this.restore_rf_internal(cb);
				  }
			  }
			
		},
		/**
		 * Returns a random integer between min (inclusive) and max (inclusive).
		 * The value is no lower than min (or the next integer greater than min
		 * if min isn't an integer) and no greater than max (or the next integer
		 * lower than max if max isn't an integer).
		 * Using Math.round() will give you a non-uniform distribution!
		 */
		getRandomInt(min, max) {
			min = Math.ceil(min);
			max = Math.floor(max);
			return Math.floor(Math.random() * (max - min + 1)) + min;
		},
        restore_rf_internal(cb){
            this.status += '<br/>Restoring RF config...';
            console.log('restore rf ');
            let url = window.device+'/api/flash/'+this.getRFAddress();
            console.log('Will use URL '+url);
			let correct_rf_config;

// At this moment, I am not sure if we can use single format for T and N
// Those are RF configs copied from my devices
            if(this.chipset === "BK7231T") {
				correct_rf_config = [0x54,0x4c,0x56,0x00,0xe0,0x01,0x00,0x00,0x00,0x11,0x11,0x11,0x5a,0x00,0x00,0x00,0x01,0x11,0x11,0x11,0x04,0x00,0x00,0x00,0x4e,0x61,0xbc,0x00,0x02,0x11,0x11,0x11,
0x06,0x00,0x00,0x00,0x84,0xe3,0x42,0xb2,0x61,0xbf,0x03,0x11,0x11,0x11,0x04,0x00,0x00,0x00,0x1d,0x01,0x00,0x00,0x04,0x11,0x11,0x11,0x04,0x00,0x00,0x00,0x8e,0x15,
0x53,0x01,0x05,0x11,0x11,0x11,0x04,0x00,0x00,0x00,0x1b,0x00,0x00,0x00,0x06,0x11,0x11,0x11,0x04,0x00,0x00,0x00,0x55,0x00,0x54,0x03,0x07,0x11,0x11,0x11,0x08,0x00,
0x00,0x00,0x10,0x00,0x00,0x00,0x10,0x00,0x00,0x00,0x00,0x22,0x22,0x22,0xa2,0x00,0x00,0x00,0x01,0x22,0x22,0x22,0x04,0x00,0x00,0x00,0x0f,0x00,0x00,0x00,0x02,0x22,
0x22,0x22,0x0e,0x00,0x00,0x00,0x0f,0x8f,0x8f,0x8e,0x8e,0x8e,0x8d,0x8d,0x8d,0x8c,0x8b,0x8b,0x0a,0x8a,0x03,0x22,0x22,0x22,0x0e,0x00,0x00,0x00,0x11,0x91,0x91,0x90,
0x8f,0x8f,0x8e,0x8d,0x8d,0x8c,0x8b,0x8a,0x09,0x89,0x04,0x22,0x22,0x22,0x0e,0x00,0x00,0x00,0x0e,0x8e,0x8e,0x8d,0x8c,0x8c,0x8b,0x8a,0x8a,0x89,0x88,0x87,0x06,0x86,
0x05,0x22,0x22,0x22,0x04,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x06,0x22,0x22,0x22,0x04,0x00,0x00,0x00,0x03,0x00,0x00,0x00,0x07,0x22,0x22,0x22,0x28,0x00,0x00,0x00,
0x90,0x90,0x90,0x90,0x90,0x8f,0x8f,0x8f,0x8f,0x8f,0x8e,0x8e,0x8e,0x8e,0x8e,0x8d,0x8d,0x8d,0x8d,0x0c,0x8c,0x8c,0x8c,0x8c,0x8c,0x8c,0x8c,0x8c,0x8c,0x8c,0x8c,0x8c,
0x8c,0x8c,0x8c,0x8c,0x8c,0x8c,0x8c,0x8c,0x08,0x22,0x22,0x22,0x04,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x33,0x33,0x33,0x84,0x00,0x00,0x00,0x01,0x33,0x33,0x33,
0x04,0x00,0x00,0x00,0x08,0x00,0x00,0x00,0x02,0x33,0x33,0x33,0x04,0x00,0x00,0x00,0x0a,0x00,0x00,0x00,0x03,0x33,0x33,0x33,0x04,0x00,0x00,0x00,0x09,0x00,0x00,0x00,
0x04,0x33,0x33,0x33,0x04,0x00,0x00,0x00,0x03,0x02,0x00,0x00,0x05,0x33,0x33,0x33,0x04,0x00,0x00,0x00,0xf8,0x01,0x00,0x00,0x06,0x33,0x33,0x33,0x04,0x00,0x00,0x00,
0xe8,0x03,0x00,0x00,0x07,0x33,0x33,0x33,0x04,0x00,0x00,0x00,0xff,0x03,0x00,0x00,0x08,0x33,0x33,0x33,0x04,0x00,0x00,0x00,0x10,0x00,0x00,0x00,0x09,0x33,0x33,0x33,
0x04,0x00,0x00,0x00,0x10,0x00,0x00,0x00,0x0a,0x33,0x33,0x33,0x04,0x00,0x00,0x00,0x00,0x02,0x00,0x00,0x0b,0x33,0x33,0x33,0x04,0x00,0x00,0x00,0x00,0x02,0x00,0x00,
0x00,0x44,0x44,0x44,0x40,0x00,0x00,0x00,0x01,0x44,0x44,0x44,0x20,0x00,0x00,0x00,0x80,0x80,0x80,0x80,0x78,0x80,0x78,0x80,0x70,0x84,0x70,0x84,0x60,0x8c,0x58,0x94,
0x56,0x94,0x56,0x94,0x54,0x94,0x54,0x94,0x55,0x95,0x54,0x95,0x55,0x95,0x54,0x95,0x02,0x44,0x44,0x44,0x04,0x00,0x00,0x00,0xee,0x01,0x00,0x00,0x03,0x44,0x44,0x44,
0x04,0x00,0x00,0x00,0x07,0x00,0x00,0x00];
// NOTE: MAC 84:e3:42:b2:61:bf
				correct_rf_config[39] = this.getRandomInt(0,255);// replace 0xb2
				correct_rf_config[40] = this.getRandomInt(0,255);// replace 0x61
				correct_rf_config[41] = this.getRandomInt(0,255);// replace 0xbf
			}
            else if(this.chipset === "BK7231N") {
				correct_rf_config = [0x54,0x4c,0x56,0x00,0x62,0x00,0x00,0x00,0x00,0x11,0x11,0x11,0x5a,0x00,0x00,0x00,0x01,0x11,0x11,0x11,0x04,0x00,0x00,0x00,0x4e,0x61,0xbc,0x00,0x02,0x11,0x11,0x11
,0x06,0x00,0x00,0x00,0x38,0x1f,0x8d,0x38,0x57,0x0e,0x03,0x11,0x11,0x11,0x04,0x00,0x00,0x00,0x5e,0x01,0x00,0x00,0x04,0x11,0x11,0x11,0x04,0x00,0x00,0x00,0x8e,0x15
,0x53,0x01,0x05,0x11,0x11,0x11,0x04,0x00,0x00,0x00,0x0c,0x00,0x00,0x00,0x06,0x11,0x11,0x11,0x04,0x00,0x00,0x00,0x55,0x00,0x54,0x03,0x07,0x11,0x11,0x11,0x08,0x00
,0x00,0x00,0x80,0x00,0x00,0x00,0x80,0x00,0x00,0x00,0xff,0xff,0xff,0xff,0xff,0xff,0xff];
// NOTE: MAC 38:1f:8d:38:57:0e
				correct_rf_config[39] = this.getRandomInt(0,255);// replace 0x38
				correct_rf_config[40] = this.getRandomInt(0,255);// replace 0x57
				correct_rf_config[41] = this.getRandomInt(0,255);// replace 0x0e
			} else {
				correct_rf_config = [];
			}
			
			let streamData = new Uint8Array(correct_rf_config);
            if (streamData){
                fetch(url, { 
                        method: 'POST',
                        body: streamData
                    })
                    .then(response => response.text())
                    .then(text => {
                        console.log('received '+text);
                        this.status += '<br/>RF restored!';
                    })
                    .catch(err => console.error(err)); // Never forget the final catch!
            }
        },
        dump(buffer){
            this.display = '<pre>';
            const view = new Uint8Array(buffer);

            let linestart = '0000: ';
            let lineend = '';

            for (let i = 0; i < buffer.byteLength; i++){
                if (i && !(i % 32)){
                    this.display += (linestart + ' : '+lineend + '\n');
                    linestart = ('000'+i.toString(16)).slice(-4) +': ';
                    lineend = '';
                    this.display += '\n';
                }
                linestart += ('0'+view[i].toString(16)).slice(-2) + ' ';
                lineend += (view[i] < 0x20)? '.':String.fromCharCode(view[i]);
            }
            this.display += linestart + ' : '+lineend + '\n';
            this.display += '</pre>';
        }

    },
    mounted (){
        this.msg = 'fred';

        this.rfurl = window.device+'/api/flash/'+this.getRFAddress();
        this.configurl = window.device+'/api/flash/'+this.getConfigAddress();
        this.flashvarsurl = window.device+'/api/flash/'+this.getFlashVarsAddress();

        console.log('mounted ota');
        this.getinfo();
    }
  }
//@ sourceURL=/vue/flash.vue
</script>

<style scoped>
.display pre{
    font-family: 'Courier New', Courier, monospace;
    font-size: 14px;
}
</style>
